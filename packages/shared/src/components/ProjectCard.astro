---
import type { Project } from '../lib/projects'
import { STATUS_CONFIG } from '../lib/projects'

interface Props {
  project: Project
  variant?: 'full' | 'compact' | 'grid'
  showStats?: boolean
}

const { project, variant = 'full', showStats = true } = Astro.props
const statusConfig = STATUS_CONFIG[project.status]
const isActive = project.status === 'live' || project.status === 'in-progress'
const isExternal = project.external === true
const analysisUrl = `/analysis?project=${encodeURIComponent(project.id)}`

// Pass Supabase config to client script
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY
---

{variant === 'grid' ? (
  <!-- Grid variant: Compact card for 3-column layout -->
  <div class='group flex flex-col border border-border bg-primary-foreground p-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md hover:border-foreground/20'>
    {/* Header: Image + Title + Badge */}
    <div class='flex gap-3 items-start'>
      {project.image && (
        <img
          src={project.image}
          alt={`${project.name} thumbnail`}
          class='h-16 w-16 shrink-0 rounded-lg object-cover border border-border'
        />
      )}
      <div class='flex-1 min-w-0'>
        <div class='flex items-start justify-between gap-2'>
          <h3 class='text-base font-semibold text-foreground leading-tight'>
            {project.name}
          </h3>
          <span class={`shrink-0 inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium ${statusConfig.bgColor} ${statusConfig.textColor}`}>
            <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
            {statusConfig.label}
          </span>
        </div>
      </div>
    </div>

    {/* Description (2 lines max) */}
    <p class='mt-3 text-sm text-muted-foreground line-clamp-2'>
      {project.shortDescription || project.description}
    </p>

    {/* Tags (max 3) */}
    <div class='flex flex-wrap gap-1.5 mt-3'>
      {project.tags.slice(0, 3).map((tag) => (
        <span class='bg-muted px-2 py-0.5 text-xs text-muted-foreground'>
          {tag.name}
        </span>
      ))}
    </div>

    {/* Single CTA - wrapper with mt-auto pushes to bottom */}
    <div class='mt-auto pt-4'>
      <a
        href={project.url}
        target={isExternal ? '_blank' : undefined}
        rel={isExternal ? 'noopener noreferrer' : undefined}
        class='inline-flex w-full items-center justify-center gap-2 bg-foreground px-4 py-2 text-sm font-medium text-background transition hover:bg-foreground/90'
      >
        Try It →
      </a>
    </div>
  </div>
) : variant === 'full' ? (
  <!-- Full variant: Build Log style (large card, "Try It →" button) -->
  <div class='border border-border bg-primary-foreground p-6 shadow-lg shadow-black/5 transition hover:-translate-y-0.5 hover:border-foreground/30 hover:shadow-xl'>
    <div class='flex flex-wrap items-center justify-between gap-4'>
      <div class='flex gap-5'>
        {/* Project thumbnail - hidden on mobile */}
        {project.image && (
          <img
            src={project.image}
            alt={`${project.name} thumbnail`}
            class='hidden sm:block h-24 w-24 shrink-0 rounded-lg object-cover border border-border'
          />
        )}
        <div class='space-y-3'>
          <div class='flex items-center gap-3'>
            <h3 class='text-xl font-semibold text-foreground'>{project.name}</h3>
            <span class={`inline-flex items-center gap-1 px-2.5 py-1 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
              <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
              {statusConfig.label}
            </span>
          </div>
          <p class='max-w-xl text-sm text-muted-foreground'>
            {project.description}
          </p>
          <div class='flex flex-wrap gap-2'>
            {project.tags.map((tag) => (
              <span class='bg-muted px-2.5 py-1 text-sm font-medium text-muted-foreground'>
                {tag.name}
              </span>
            ))}
          </div>

          {/* Standard Engagement Stats */}
          {showStats && isActive && !isExternal && (
            <div
              class='project-engagement-stats pt-2 text-sm text-muted-foreground'
              data-project-id={project.id}
              data-supabase-url={supabaseUrl}
              data-supabase-key={supabaseKey}
            >
              <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='total_views'>—</span> Total Views
              <span class='mx-2'>|</span>
              <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='views_30d'>—</span> P30D Views
              <span class='mx-2'>|</span>
              Project View Rank: <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='rank'>—</span>
            </div>
          )}
        </div>
      </div>
      <div class={`flex flex-col gap-2 sm:flex-row ${isExternal ? 'basis-full' : ''}`}>
        {!isExternal && (
          <a
            href={analysisUrl}
            class='inline-flex items-center gap-2 border border-sky-500 bg-sky-50 px-5 py-2.5 text-sm font-semibold text-sky-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-sky-100 dark:bg-sky-500/10 dark:text-sky-400 dark:hover:bg-sky-500/20'
          >
            Analysis
          </a>
        )}
        <a
          href={project.url}
          target={isExternal ? '_blank' : undefined}
          rel={isExternal ? 'noopener noreferrer' : undefined}
          class='inline-flex items-center gap-2 bg-foreground px-5 py-2.5 text-sm font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
        >
          Try It →
        </a>
      </div>
    </div>
  </div>
) : (
  <!-- Compact variant: Smaller version with right-aligned buttons -->
  <div class='border border-border bg-primary-foreground p-4 shadow-sm transition hover:-translate-y-0.5 hover:border-foreground/30 hover:shadow-md'>
    <div class='flex flex-wrap items-center justify-between gap-4'>
      <div class='flex gap-4'>
        {/* Project thumbnail - hidden on mobile */}
        {project.image && (
          <img
            src={project.image}
            alt={`${project.name} thumbnail`}
            class='hidden sm:block h-20 w-20 shrink-0 rounded-lg object-cover border border-border'
          />
        )}
        <div class='space-y-2'>
          <div class='flex items-center gap-2'>
            <h3 class='text-lg font-semibold text-foreground'>{project.name}</h3>
            <span class={`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-semibold ${statusConfig.bgColor} ${statusConfig.textColor}`}>
              <span class={`h-1.5 w-1.5 rounded-full ${statusConfig.dotColor}`}></span>
              {statusConfig.label}
            </span>
          </div>
          <p class='max-w-xl text-sm text-muted-foreground'>
            {project.description}
          </p>
          <div class='flex flex-wrap gap-1.5'>
            {project.tags.map((tag) => (
              <span class='bg-muted px-2 py-0.5 text-xs font-medium text-muted-foreground'>
                {tag.name}
              </span>
            ))}
          </div>

          {/* Standard Engagement Stats */}
          {showStats && isActive && !isExternal && (
            <div
              class='project-engagement-stats pt-1 text-xs text-muted-foreground'
              data-project-id={project.id}
              data-supabase-url={supabaseUrl}
              data-supabase-key={supabaseKey}
            >
              <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='total_views'>—</span> Total Views
              <span class='mx-1.5'>|</span>
              <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='views_30d'>—</span> P30D Views
              <span class='mx-1.5'>|</span>
              Project View Rank: <span class='stat-value font-semibold text-foreground tabular-nums' data-stat='rank'>—</span>
            </div>
          )}
        </div>
      </div>
      <div class={`flex flex-col gap-2 sm:flex-row ${isExternal ? 'basis-full' : ''}`}>
        {!isExternal && (
          <a
            href={analysisUrl}
            class='inline-flex items-center gap-2 border border-sky-500 bg-sky-50 px-4 py-2 text-sm font-semibold text-sky-700 shadow-sm transition hover:-translate-y-0.5 hover:bg-sky-100 dark:bg-sky-500/10 dark:text-sky-400 dark:hover:bg-sky-500/20'
          >
            Analysis
          </a>
        )}
        <a
          href={project.url}
          target={isExternal ? '_blank' : undefined}
          rel={isExternal ? 'noopener noreferrer' : undefined}
          class='inline-flex items-center gap-2 bg-foreground px-4 py-2 text-sm font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90'
        >
          Try It →
        </a>
      </div>
    </div>
  </div>
)}

{/* Client-side hydration script for standard engagement stats */}
<script is:inline>
  // Hydrate engagement stats on page load
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.project-engagement-stats').forEach(async (container) => {
      const projectId = container.getAttribute('data-project-id')
      const supabaseUrl = container.getAttribute('data-supabase-url')
      const supabaseKey = container.getAttribute('data-supabase-key')
      
      if (!projectId || !supabaseUrl || !supabaseKey) return
      
      try {
        const response = await fetch(
          `${supabaseUrl}/rest/v1/rpc/project_engagement_stats`,
          {
            method: 'POST',
            headers: {
              'apikey': supabaseKey,
              'Authorization': `Bearer ${supabaseKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ p_project_id: projectId })
          }
        )
        
        if (!response.ok) return
        
        const rows = await response.json()
        const data = rows[0]
        if (!data) return
        
        const totalEl = container.querySelector('[data-stat="total_views"]')
        const views30dEl = container.querySelector('[data-stat="views_30d"]')
        const rankEl = container.querySelector('[data-stat="rank"]')
        
        if (totalEl && data.total_views !== undefined) {
          totalEl.textContent = data.total_views.toLocaleString()
        }
        if (views30dEl && data.views_30d !== undefined) {
          views30dEl.textContent = data.views_30d.toLocaleString()
        }
        if (rankEl && data.rank !== undefined) {
          rankEl.textContent = `#${data.rank}`
        }
      } catch (error) {
        console.debug('Could not load engagement stats:', error)
      }
    })
  })
</script>
