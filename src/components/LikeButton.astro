---
// LikeButton component - Anonymous likes via PostHog webhook â†’ Supabase
// Uses localStorage to prevent double-likes and show optimistic UI

interface Props {
  path: string;
  class?: string;
}

const { path, class: className } = Astro.props;

// Fetch initial count from Supabase (server-side)
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

let initialCount = 0;
try {
  const res = await fetch(
    `${supabaseUrl}/rest/v1/rpc/get_likes`,
    {
      method: 'POST',
      headers: {
        'apikey': supabaseKey,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ p_path: path }),
    }
  );
  if (res.ok) {
    const count = await res.json();
    initialCount = count || 0;
  }
} catch (e) {
  // Silently fail, show 0
}
---

<div 
  class:list={["like-button-container inline-flex items-center gap-2", className]}
  data-path={path}
  data-initial-count={initialCount}
>
  <button
    type="button"
    class="like-btn group flex items-center gap-1.5 rounded-full border border-border bg-background px-3 py-1.5 text-sm transition-all hover:border-accent hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-accent/50"
    aria-label="Like this post"
  >
    <svg
      class="like-icon h-4 w-4 transition-transform group-hover:scale-110"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      ></path>
    </svg>
    <span class="like-count font-medium">{initialCount}</span>
  </button>
</div>

<style>
  .like-btn.liked {
    @apply border-red-400 bg-red-50 text-red-600;
  }
  .like-btn.liked .like-icon {
    fill: currentColor;
  }
  :global(.dark) .like-btn.liked {
    @apply border-red-500 bg-red-950/30 text-red-400;
  }
</style>

<script>
  function initLikeButtons() {
    const containers = document.querySelectorAll('.like-button-container');
    
    containers.forEach((container) => {
      const btn = container.querySelector('.like-btn') as HTMLButtonElement;
      const countEl = container.querySelector('.like-count') as HTMLSpanElement;
      const path = container.getAttribute('data-path') || '';
      const initialCount = parseInt(container.getAttribute('data-initial-count') || '0', 10);
      
      const storageKey = `liked:${path}`;
      const hasLiked = localStorage.getItem(storageKey) === 'true';
      
      // Set initial state
      let count = initialCount;
      if (hasLiked) {
        btn.classList.add('liked');
        btn.setAttribute('aria-pressed', 'true');
      }
      
      btn.addEventListener('click', async () => {
        // Already liked - do nothing (or could implement unlike)
        if (localStorage.getItem(storageKey) === 'true') {
          return;
        }
        
        // Optimistic update
        count += 1;
        countEl.textContent = String(count);
        btn.classList.add('liked');
        btn.setAttribute('aria-pressed', 'true');
        localStorage.setItem(storageKey, 'true');
        
        // Track via PostHog
        try {
          if (typeof window !== 'undefined' && (window as any).posthog?.capture) {
            (window as any).posthog.capture('post_liked', { path });
          }
        } catch (e) {
          console.error('Failed to track like:', e);
        }
      });
    });
  }
  
  // Run on initial load and on Astro page transitions
  initLikeButtons();
  document.addEventListener('astro:page-load', initLikeButtons);
</script>
