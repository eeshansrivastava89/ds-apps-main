---
import PageLayout from '../../layouts/BaseLayout.astro'
---

<PageLayout meta={{ title: 'A/B Test Simulator' }}>
	<div class="w-full space-y-8">
		<!-- Header -->
		<div class="space-y-2">
			<h1 class="text-3xl font-bold">A/B Test Simulator</h1>
			<p class="text-base text-muted-foreground">Interactive word search puzzle demonstrating A/B testing with PostHog experiments and real-time analytics</p>
		</div>

		<!-- Challenge Info -->
		<div id="challenge-section" class="rounded-lg border bg-card p-4">
			<h3 class="mb-3 font-semibold">Your Challenge</h3>
			<div class="grid grid-cols-2 gap-3 md:grid-cols-4">
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Variant</div>
					<div id="user-variant" class="font-mono font-bold">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Username</div>
					<div id="user-username" class="truncate font-mono">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Difficulty</div>
					<div id="difficulty-display" class="font-mono">Loading...</div>
				</div>
				<div class="text-sm">
					<div class="text-xs text-muted-foreground">Find Words</div>
					<div id="target-word-count" class="font-mono font-bold">0</div>
				</div>
			</div>
		</div>

		<!-- Puzzle Section -->
		<div id="puzzle-section" class="space-y-4 rounded-lg border bg-card p-4">
			<h3 class="font-semibold">Find the Words</h3>
			
			<!-- Three-column layout: Grid (1/3) + Controls (1/3) + Stats (1/3) -->
			<div class="grid gap-6" style="grid-template-columns: 1fr 1fr 1fr;">
				<!-- LEFT: Letter Grid (1/3) -->
				<div>
					<div id="letter-grid" class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(44px, 1fr));"></div>
				</div>

				<!-- CENTER: Controls & Info (1/3) -->
				<div class="space-y-4">
					<!-- Timer + Try Again Button (always visible, changes state) -->
					<div class="grid grid-cols-2 gap-2">
						<!-- Timer -->
						<div class="flex flex-col items-center justify-center rounded-lg bg-muted p-4">
							<div class="text-xs text-muted-foreground mb-1">Time</div>
							<div id="timer" class="font-mono text-2xl font-bold">00:60:00</div>
						</div>

						<!-- Action Button (Start / Try Again / Reset) -->
						<div id="controls" class="flex flex-col gap-2">
							<button id="start-button" class="flex-1 rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors">Start</button>
							<button id="reset-button" class="hidden flex-1 rounded-lg bg-secondary px-3 py-2 text-sm font-medium text-secondary-foreground hover:bg-secondary/80 transition-colors">Stop</button>
							<button id="try-again-inline-button" class="hidden flex-1 rounded-lg bg-orange-600 px-3 py-2 text-sm font-medium text-white hover:bg-orange-700 transition-colors">Try Again</button>
						</div>
					</div>

					<!-- Input Box (hidden until started) -->
					<div id="input-section" class="hidden space-y-2">
						<label for="word-input" class="text-xs font-medium text-muted-foreground">Enter Word</label>
						<input type="text" id="word-input" placeholder="Type a word..." autocomplete="off" class="w-full rounded-lg border bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
					</div>

					<!-- Found Words -->
					<div id="found-words" class="rounded-lg bg-muted p-3">
						<div class="text-xs text-muted-foreground mb-2">Found Words</div>
						<div id="found-words-list" class="font-mono text-sm">(none yet)</div>
					</div>
				</div>

				<!-- RIGHT: Leaderboard (1/3) -->
				<div id="leaderboard-display" class="rounded-lg border bg-muted p-3">
					<h4 class="text-xs font-semibold text-muted-foreground uppercase tracking-wide">üèÜ Top Players</h4>
					<div id="leaderboard-list" class="space-y-1.5 mt-2 text-xs"></div>
				</div>
			</div>
		</div>

		<!-- Result Card (modular, single-line design) -->
		<div id="result-card" class="hidden rounded-lg border border-green-200 bg-green-50 p-4 dark:border-green-900 dark:bg-green-950">
			<div class="flex flex-wrap items-center justify-between gap-4">
				<!-- Left: Status Badge -->
				<div class="inline-flex items-center gap-3 px-3 py-2 rounded-lg bg-white dark:bg-slate-950 border border-green-200 dark:border-green-900">
					<span class="text-xl">üéâ</span>
					<div>
						<p class="text-xs font-semibold text-muted-foreground uppercase tracking-wide">Challenge Complete</p>
						<p id="result-message" class="text-sm font-bold">üèÜ Personal Best!</p>
					</div>
				</div>

				<!-- Middle: Stats (Time & Guesses) -->
				<div class="flex items-center gap-4 px-3 py-2 rounded-lg bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800">
					<div class="text-center">
						<p class="text-xs text-muted-foreground">Time</p>
						<p class="font-mono font-bold text-base"><span id="result-time">00:00:00</span></p>
					</div>
					<div style="width: 1px; height: 2rem; background-color: #e5e7eb; dark:background-color: #374151;"></div>
					<div class="text-center">
						<p class="text-xs text-muted-foreground">Guesses</p>
						<p class="font-mono font-bold text-base"><span id="result-guesses">0</span></p>
					</div>
				</div>

				<!-- Right: Actions -->
				<div class="flex gap-2">
					<button id="try-again-inline-button" class="hidden rounded-lg bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700 transition-colors">Try Again</button>
					<a href="#dashboard-section" class="rounded-lg bg-secondary px-4 py-2 text-sm font-medium text-secondary-foreground hover:bg-secondary/80 transition-colors">View Stats</a>
				</div>
			</div>
		</div>

		<!-- Completion -->
		<div id="completion-message" class="hidden space-y-3 rounded-lg border border-green-200 bg-green-50 p-4 dark:border-green-900 dark:bg-green-950">
			<h3 class="text-lg font-bold">üéâ Challenge Complete!</h3>
			<div class="grid gap-2 text-sm md:grid-cols-2">
				<div>
					<span class="text-muted-foreground">Time:</span>
					<span id="completion-time-display" class="font-mono font-bold">00:00:00</span>
				</div>
				<div>
					<span class="text-muted-foreground">Guesses:</span>
					<span id="completion-guesses" class="font-mono font-bold">0</span>
				</div>
			</div>
			<p id="comparison-text" class="text-sm">Great job! Check the dashboard below for detailed stats.</p>
			<div class="flex gap-2">
				<button id="try-again-button" class="rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">Try Again</button>
				<a href="#dashboard-section" class="rounded-lg bg-secondary px-3 py-2 text-sm font-medium text-secondary-foreground hover:bg-secondary/80">View Stats</a>
			</div>
		</div>

		<!-- Failure -->
		<div id="failure-message" class="hidden space-y-3 rounded-lg border border-red-200 bg-red-50 p-4 dark:border-red-900 dark:bg-red-950">
			<h3 class="text-lg font-bold">‚è∞ Time's Up!</h3>
			<p class="text-sm">You found <span id="failure-words-found">0</span> out of <span id="failure-words-total">0</span> words.</p>
			<div class="flex gap-2">
				<button id="try-again-failure-button" class="rounded-lg bg-primary px-3 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">Try Again</button>
				<a href="#dashboard-section" class="rounded-lg bg-secondary px-3 py-2 text-sm font-medium text-secondary-foreground hover:bg-secondary/80">View Stats</a>
			</div>
		</div>

		<!-- Leaderboard -->
		<div id="leaderboard-display" class="hidden space-y-3 rounded-lg border bg-card p-4">
			<h3 class="font-semibold">üèÜ Leaderboard</h3>
			<div id="leaderboard-list" class="space-y-2 text-sm"></div>
		</div>

		<!-- Dashboard -->
		<div id="dashboard-section" class="space-y-6 rounded-lg border bg-card p-4">
			<div class="flex items-center justify-between">
				<div>
					<h3 class="font-semibold">üìä Analytics Dashboard</h3>
					<p class="text-xs text-muted-foreground">Real-time A/B test results</p>
				</div>
				<div id="update-indicator" class="text-xs text-muted-foreground">
					<span id="last-updated">Loading...</span>
				</div>
			</div>

			<!-- Comparison Card (High Priority) -->
			<div id="comparison-card" class="rounded-lg border bg-gradient-to-br from-card to-muted p-6">
				<div class="flex items-center justify-center h-24">
					<div class="text-center">
						<div class="h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
						<div class="text-sm text-muted-foreground">Loading comparison...</div>
					</div>
				</div>
			</div>

			<!-- Funnel Chart (Moved up) -->
			<div class="rounded-lg border bg-card p-4">
				<div id="funnel-chart"></div>
			</div>

			<!-- Charts Grid: Avg Time + Distribution -->
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
				<!-- Avg Time Chart -->
				<div class="rounded-lg border bg-card p-4">
					<div id="avg-time-chart"></div>
				</div>

				<!-- Distribution Chart (Histogram) -->
				<div class="rounded-lg border bg-card p-4">
					<div id="distribution-chart"></div>
				</div>
			</div>

			<!-- Recent Completions Table -->
			<div class="rounded-lg border bg-card p-4">
				<h4 class="text-sm font-semibold mb-4">Recent Completions</h4>
				<div id="completions-table" class="overflow-x-auto">
					<div class="text-sm text-muted-foreground text-center py-8">Loading...</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
		<script is:inline>
		// Auto-detect API URL
		const API_URL = window.location.hostname === 'localhost'
			? 'http://localhost:8000'
			: 'https://soma-analytics.fly.dev';

		// Color scheme matching your design
		const colors = {
			variantA: '#6366f1',    // indigo
			variantB: '#ef4444',    // red
			median: '#10b981',      // green
			p25: '#f59e0b',         // amber
			grid: '#e5e7eb',
			gridDark: '#374151'
		};

		// Get Plotly theme config
		function getPlotlyTheme() {
			const isDark = document.documentElement.classList.contains('dark');
			const textColor = isDark ? '#e5e7eb' : '#374151';
			const gridColor = isDark ? '#1f2937' : '#f3f4f6';
			const lineColor = isDark ? '#374151' : '#e5e7eb';

			return {
				font: { family: 'Satoshi, sans-serif', size: 12, color: textColor },
				paper_bgcolor: 'rgba(0,0,0,0)',
				plot_bgcolor: 'rgba(0,0,0,0)',
				xaxis: { gridcolor: gridColor, linecolor: lineColor, zerolinecolor: lineColor },
				yaxis: { gridcolor: gridColor, linecolor: lineColor, zerolinecolor: lineColor }
			};
		}

		// Format time helper
		function getLastUpdateTime() {
			const now = new Date();
			return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
		}

		// Render comparison card
		function renderComparison(comparison) {
			const diff = comparison.percentage_difference;
			const isSignificant = Math.abs(diff) > 10;
			const isWinnerB = diff < 0;
			
			const card = document.getElementById('comparison-card');
			card.innerHTML = `
				<div class="grid gap-4" style="grid-template-columns: 2fr 1fr;">
					<!-- 2/3 width: Variants A & B Card -->
					<div class="rounded-2xl border border-border bg-primary-foreground p-4">
						<div class="grid grid-cols-2 gap-6">
							<div>
								<div class="text-xs text-muted-foreground">Variant A<br><span class="text-xs">(3 words)</span></div>
								<div class="font-mono text-3xl font-bold">${comparison.variant_a_avg}s</div>
								<div class="text-xs text-muted-foreground mt-1">${comparison.variant_a_completions} completions</div>
							</div>
							<div>
								<div class="text-xs text-muted-foreground">Variant B<br><span class="text-xs">(4 words)</span></div>
								<div class="font-mono text-3xl font-bold">${comparison.variant_b_avg}s</div>
								<div class="text-xs text-muted-foreground mt-1">${comparison.variant_b_completions} completions</div>
							</div>
						</div>
					</div>
					<!-- 1/3 width: Comparison Result Card -->
					<div class="rounded-2xl border border-border bg-primary-foreground p-4 flex flex-col justify-center items-center text-center">
						<div class="text-sm font-semibold mb-2 ${isSignificant ? (isWinnerB ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400') : 'text-foreground'}">${comparison.interpretation}</div>
						<div class="text-xs text-muted-foreground">
							<span class="font-mono font-bold block">${diff > 0 ? '+' : ''}${diff}%</span>
							<span>${isSignificant ? 'significant' : 'not significant'}</span>
						</div>
					</div>
				</div>
			`;
		}

		// Render average time chart
		function renderAvgTimeChart(stats, theme) {
			if (!stats || stats.length < 2) return;

			const trace = {
				x: ['Variant A', 'Variant B'],
				y: [stats[0].avg_completion_time, stats[1].avg_completion_time],
				type: 'bar',
				marker: { color: [colors.variantA, colors.variantB] },
				text: [stats[0].avg_completion_time.toFixed(2) + 's', stats[1].avg_completion_time.toFixed(2) + 's'],
				//textposition: 'outside'
			};

			const layout = {
				title: { text: 'Average Completion Time', font: { size: 14 } },
				font: theme.font,
				paper_bgcolor: theme.paper_bgcolor,
				plot_bgcolor: theme.plot_bgcolor,
				xaxis: { title: '', gridcolor: theme.xaxis.gridcolor, linecolor: theme.xaxis.linecolor },
				yaxis: { title: 'Seconds', gridcolor: theme.yaxis.gridcolor, linecolor: theme.yaxis.linecolor },
				height: 320,
				margin: { l: 50, r: 50, t: 50, b: 40 },
				automargin: true,
				showlegend: false
			};

			Plotly.newPlot('avg-time-chart', [trace], layout, { responsive: true, displayModeBar: false });
		}

		// Compute simple Gaussian KDE
		function computeKDE(data) {
			if (!data || data.length === 0) return { x: [], y: [] };
			
			const mean = data.reduce((a, b) => a + b) / data.length;
			const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / data.length;
			const std = Math.sqrt(variance);
			const bandwidth = std * Math.pow(data.length, -0.2);

			const min = Math.min(...data);
			const max = Math.max(...data);
			const xPoints = [];
			const yPoints = [];
			
			for (let i = 0; i <= 150; i++) {
				const x = min + (max - min) * i / 150;
				xPoints.push(x);
				
				let density = 0;
				for (let j = 0; j < data.length; j++) {
					density += Math.exp(-Math.pow((x - data[j]) / bandwidth, 2) / 2);
				}
				yPoints.push(density / (data.length * bandwidth * Math.sqrt(2 * Math.PI)));
			}
			
			return { x: xPoints, y: yPoints };
		}

		// Render KDE distribution
		function renderDistributionChart(distributionData, theme) {
			if (!distributionData.variant_a_times || !distributionData.variant_b_times) return;

			const kdeA = computeKDE(distributionData.variant_a_times);
			const kdeB = computeKDE(distributionData.variant_b_times);

			const traces = [
				{
					x: kdeA.x,
					y: kdeA.y,
					type: 'scatter',
					mode: 'lines',
					name: 'Variant A',
					line: { color: colors.variantA, width: 2 },
					fill: 'tozeroy',
					fillcolor: 'rgba(99, 102, 241, 0.2)'
				},
				{
					x: kdeB.x,
					y: kdeB.y,
					type: 'scatter',
					mode: 'lines',
					name: 'Variant B',
					line: { color: colors.variantB, width: 2 },
					fill: 'tozeroy',
					fillcolor: 'rgba(239, 68, 68, 0.2)'
				}
			];

			const layout = {
				title: { text: 'Completion Time Distribution (KDE)', font: { size: 14 } },
				font: theme.font,
				paper_bgcolor: theme.paper_bgcolor,
				plot_bgcolor: theme.plot_bgcolor,
				xaxis: { title: 'Completion Time (seconds)', gridcolor: theme.xaxis.gridcolor, linecolor: theme.xaxis.linecolor },
				yaxis: { title: 'Density', gridcolor: theme.yaxis.gridcolor, linecolor: theme.yaxis.linecolor },
				height: 320,
				margin: { l: 50, r: 30, t: 50, b: 40 },
				showlegend: true
			};

			Plotly.newPlot('distribution-chart', traces, layout, { responsive: true, displayModeBar: false });
		}

		// Render funnel chart using Plotly's funnel type
		function renderFunnelChart(funnel, theme) {
			const variantA = funnel.filter(f => f.variant === 'A').sort((a, b) => a.stage_order - b.stage_order);
			const variantB = funnel.filter(f => f.variant === 'B').sort((a, b) => a.stage_order - b.stage_order);

			const traces = [
				{
					type: 'funnel',
					y: variantA.map(f => f.stage),
					x: variantA.map(f => f.event_count),
					name: 'Variant A',
					marker: { color: colors.variantA },
					textposition: 'inside',
					textinfo: 'value+percent initial'
				},
				{
					type: 'funnel',
					y: variantB.map(f => f.stage),
					x: variantB.map(f => f.event_count),
					name: 'Variant B',
					marker: { color: colors.variantB },
					textposition: 'inside',
					textinfo: 'value+percent initial'
				}
			];

			const layout = {
				title: { text: 'Conversion Funnel', font: { size: 14 } },
				font: theme.font,
				paper_bgcolor: theme.paper_bgcolor,
				plot_bgcolor: theme.plot_bgcolor,
				xaxis: { gridcolor: theme.xaxis.gridcolor, linecolor: theme.xaxis.linecolor },
				yaxis: { gridcolor: theme.yaxis.gridcolor, linecolor: theme.yaxis.linecolor },
				height: 320,
				margin: { l: 100, r: 30, t: 50, b: 40 },
				showlegend: true
			};

			Plotly.newPlot('funnel-chart', traces, layout, { responsive: true, displayModeBar: false });
		}

		// Render recent completions table
		function renderCompletionsTable(completions) {
			if (!completions || completions.length === 0) {
				document.getElementById('completions-table').innerHTML = '<div class="text-sm text-muted-foreground text-center py-4">No completions yet</div>';
				return;
			}

			const rows = completions.slice(0, 10).map(c => `
				<tr class="border-b hover:bg-muted/50">
					<td class="py-2 px-3 text-sm font-mono">${c.variant}</td>
					<td class="py-2 px-3 text-sm font-mono">${c.completion_time_seconds.toFixed(1)}s</td>
					<td class="py-2 px-3 text-sm">${c.correct_words_count} words</td>
					<td class="py-2 px-3 text-sm">${c.total_guesses_count} guesses</td>
					<td class="py-2 px-3 text-xs text-muted-foreground">${new Date(c.timestamp).toLocaleTimeString()}</td>
				</tr>
			`).join('');

			document.getElementById('completions-table').innerHTML = `
				<table class="w-full text-sm">
					<thead class="border-b font-semibold">
						<tr>
							<th class="text-left py-2 px-3 text-xs text-muted-foreground">Variant</th>
							<th class="text-left py-2 px-3 text-xs text-muted-foreground">Time</th>
							<th class="text-left py-2 px-3 text-xs text-muted-foreground">Words</th>
							<th class="text-left py-2 px-3 text-xs text-muted-foreground">Guesses</th>
							<th class="text-left py-2 px-3 text-xs text-muted-foreground">When</th>
						</tr>
					</thead>
					<tbody>${rows}</tbody>
				</table>
			`;
		}

		// Main update function
		async function updateDashboard() {
			try {
				const [stats, comparison, funnel, completions, distribution] = await Promise.all([
					fetch(`${API_URL}/api/variant-stats`).then(r => r.json()),
					fetch(`${API_URL}/api/comparison`).then(r => r.json()),
					fetch(`${API_URL}/api/conversion-funnel`).then(r => r.json()),
					fetch(`${API_URL}/api/recent-completions?limit=10`).then(r => r.json()),
					fetch(`${API_URL}/api/time-distribution`).then(r => r.json())
				]);

				const theme = getPlotlyTheme();

				// Render all components
				renderComparison(comparison);
				renderFunnelChart(funnel, theme);
				renderAvgTimeChart(stats, theme);
				renderDistributionChart(distribution, theme);
				renderCompletionsTable(completions);

				// Update timestamp
				document.getElementById('last-updated').innerHTML = `Last updated: ${getLastUpdateTime()}`;
				document.getElementById('update-indicator').classList.remove('opacity-50');

			} catch (err) {
				console.error('Dashboard error:', err);
				document.getElementById('comparison-card').innerHTML = `
					<div class="rounded-lg p-4 bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-900">
						<div class="text-sm font-semibold text-red-900 dark:text-red-100 mb-1">‚ùå Error Loading Dashboard</div>
						<div class="text-xs text-red-800 dark:text-red-200">${err.message}</div>
						<div class="text-xs text-red-700 dark:text-red-300 mt-2">Check if soma-analytics API is running at ${API_URL}</div>
					</div>
				`;
			}
		}

		// Initial load
		updateDashboard();

		// Auto-refresh every 10 seconds
		setInterval(() => {
			document.getElementById('update-indicator').classList.add('opacity-50');
			updateDashboard();
		}, 10000);

		// Re-render when theme changes (dark mode toggle)
		const observer = new MutationObserver(() => {
			if (document.getElementById('avg-time-chart').hasChildNodes()) {
				updateDashboard();
			}
		});
		observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
		</script>
	</div>
</PageLayout>

<script src="/js/ab-simulator.js" is:inline></script>