---
import PageLayout from '../../layouts/BaseLayout.astro'
import {
	CATEGORY_STYLES,
	STATUS_STYLES,
	type Category,
	type Status
} from '../../data/build-with-me-config'
import { validateBuildWithMeData } from '../../lib/validate-build-with-me'

interface FilterState {
	category: Set<Category> | null
	status: Status | 'all'
}

// Data source (overwritten by fetch script). Keep defaults for local preview.
import buildWithMeData from '../../data/build-with-me-data.json'

const validatedData = validateBuildWithMeData(buildWithMeData)
if (!validatedData) {
	throw new Error('Invalid build-with-me-data.json. Run: npm run fetch:build-with-me')
}

const { cycles, tasks, hats, leaderboard } = validatedData
---

<PageLayout meta={{ title: 'Build with Me' }}>
	<div class='relative z-10 flex w-full flex-col gap-y-10 overflow-hidden px-2 py-6 sm:px-0'>
		<div
			class='bg-[radial-gradient(circle_at_20%_20%,rgba(124,58,237,0.08),transparent_40%),radial-gradient(circle_at_80%_10%,rgba(249,115,22,0.08),transparent_35%),linear-gradient(180deg,#fff 0%,#f8f3ff 35%,#fdf6f0 100%)] pointer-events-none fixed inset-0 z-0'
		>
		</div>
		<section class='relative flex flex-col gap-y-4 text-left'>
			<p class='text-xs font-semibold uppercase tracking-[0.3em] text-primary'>Build with Me</p>
			<div class='flex flex-col gap-y-3 sm:flex-row sm:items-end sm:justify-between sm:gap-x-8'>
				<div class='space-y-3'>
					<h1 class='text-4xl font-bold text-foreground'>Real Products, Real Data</h1>
					<p class='max-w-3xl text-base text-muted-foreground'>
						Monthly cycles, live apps, and open contributions. Pick a hat (Frontend, Backend,
						Analytics, Wiring/Infra, Docs), claim an issue, and ship alongside me.
					</p>
					<div class='flex flex-wrap gap-3'>
						<a
							href='#open-work'
							class='rounded-lg bg-orange-500 px-4 py-2 text-sm font-semibold text-black shadow-[0_10px_30px_rgba(249,115,22,0.25)] transition hover:-translate-y-0.5 hover:bg-orange-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 focus-visible:ring-offset-2 focus-visible:ring-offset-white'
						>
							See Open Work
						</a>
						<a
							href='#how-to'
							class='rounded-lg border border-border bg-primary-foreground px-4 py-2 text-sm font-semibold text-foreground shadow-sm transition hover:-translate-y-0.5 hover:border-foreground/50 hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/60 focus-visible:ring-offset-2 focus-visible:ring-offset-white'
						>
							How to Contribute
						</a>
					</div>
				</div>
				<div
					class='rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/10 transition hover:-translate-y-0.5'
				>
					<p class='text-xs uppercase tracking-[0.25em] text-muted-foreground'>Current Cycle</p>
					<div class='mt-2 text-lg font-semibold text-foreground'>A/B Simulator</div>
					<div class='text-sm text-muted-foreground'>Week 3 — Analysis</div>
					<div class='mt-3 flex items-center gap-3 text-xs text-foreground'>
						<span class='rounded-md bg-emerald-50 px-2 py-1 font-semibold text-emerald-700'
							>6 Open</span
						>
						<span class='rounded-md bg-amber-50 px-2 py-1 font-semibold text-amber-700'
							>2 Claimed</span
						>
						<span class='rounded-md bg-emerald-100 px-2 py-1 font-semibold text-emerald-800'
							>3 Merged</span
						>
					</div>
				</div>
			</div>
		</section>

		<section
			class='relative grid gap-4 rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/5 sm:grid-cols-2'
			aria-label='Active cycles'
		>
			{
				cycles.map((cycle) => (
					<div class='flex flex-col justify-between gap-3 rounded-xl border border-border bg-muted/60 p-4 shadow-sm shadow-black/5 transition hover:-translate-y-0.5 hover:border-foreground/30'>
						<div class='flex items-center justify-between gap-2'>
							<div>
								<p class='text-xs uppercase tracking-[0.2em] text-muted-foreground'>
									{cycle.phase}
								</p>
								<h2 class='text-lg font-semibold text-foreground'>{cycle.name}</h2>
							</div>
							<span class='rounded-lg bg-orange-100 px-3 py-1 text-xs font-semibold text-orange-800'>
								Active
							</span>
						</div>
						<p class='text-sm text-muted-foreground'>{cycle.highlight}</p>
						<div class='grid grid-cols-3 gap-2 text-center text-xs text-muted-foreground'>
							<div class='rounded-lg bg-primary-foreground p-2 shadow-inner shadow-black/5'>
								<div class='text-lg font-bold text-foreground'>{cycle.openTasks}</div>
								<div class='text-muted-foreground'>Open</div>
							</div>
							<div class='rounded-lg bg-primary-foreground p-2 shadow-inner shadow-black/5'>
								<div class='text-lg font-bold text-foreground'>{cycle.claimed}</div>
								<div class='text-muted-foreground'>Claimed</div>
							</div>
							<div class='rounded-lg bg-primary-foreground p-2 shadow-inner shadow-black/5'>
								<div class='text-lg font-bold text-foreground'>{cycle.mergedThisWeek}</div>
								<div class='text-muted-foreground'>Merged</div>
							</div>
						</div>
					</div>
				))
			}
		</section>

		<section id='open-work' class='relative space-y-4' aria-label='Open work'>
			<div class='flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between'>
				<div>
					<h2 class='text-2xl font-bold text-foreground'>Open Work</h2>
					<p class='text-sm text-muted-foreground'>Pick a hat, claim an issue, and ship.</p>
				</div>
				<div class='flex flex-wrap gap-2 text-xs text-foreground'>
					<div class='flex flex-wrap gap-2'>
						{
							(Object.keys(CATEGORY_STYLES) as Category[]).map((cat) => (
								<button
									class='data-category-btn rounded-full border border-border bg-primary-foreground px-3 py-1 text-[11px] text-foreground transition hover:border-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/60 focus-visible:ring-offset-2 focus-visible:ring-offset-white'
									data-category={cat}
									aria-pressed='false'
								>
									{cat}
								</button>
							))
						}
					</div>
					<div class='flex flex-wrap gap-2'>
						{
							(['all', 'open', 'claimed', 'in-review', 'merged'] as (Status | 'all')[]).map(
								(status) => (
									<button
										class='data-status-btn rounded-full border border-border bg-primary-foreground px-3 py-1 text-[11px] text-foreground transition hover:border-foreground/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/60 focus-visible:ring-offset-2 focus-visible:ring-offset-white'
										data-status={status}
										aria-pressed={status === 'all' ? 'true' : 'false'}
									>
										{status}
									</button>
								)
							)
						}
					</div>
				</div>
			</div>
			<div class='grid gap-3 md:grid-cols-2 xl:grid-cols-3'>
				{
					tasks.map((task) => (
						<article
							class='task-card flex h-full flex-col gap-3 rounded-2xl border border-border bg-primary-foreground p-4 shadow-md shadow-black/10 transition hover:-translate-y-0.5 hover:border-foreground/40 hover:shadow-lg'
							data-categories={task.category.join(',')}
							data-status={task.status}
						>
							<div class='flex items-start justify-between gap-2'>
								<div>
									<p class='text-xs uppercase tracking-[0.2em] text-muted-foreground'>
										{task.projectSlug === 'ab-sim' ? 'A/B Simulator' : 'Basketball Analyzer'}
									</p>
									<h3 class='text-lg font-semibold text-foreground'>{task.title}</h3>
								</div>
								<span
									class={`rounded-md px-2 py-1 text-xs font-semibold shadow-sm ${STATUS_STYLES[task.status]}`}
								>
									{task.status}
								</span>
							</div>
							<div class='flex flex-wrap gap-2'>
								{task.category.map((cat) => (
									<span
										class={`rounded-full px-3 py-1 text-[11px] font-semibold shadow ${CATEGORY_STYLES[cat]}`}
									>
										{cat}
									</span>
								))}
								{task.difficulty && (
									<span class='rounded-full border border-border bg-muted px-3 py-1 text-[11px] text-foreground'>
										{task.difficulty}
									</span>
								)}
								{task.labels?.map((label) => (
									<span class='rounded-full border border-border bg-primary-foreground px-3 py-1 text-[11px] text-muted-foreground'>
										{label}
									</span>
								))}
							</div>
							<div class='flex items-center justify-between text-xs text-muted-foreground'>
								<div class='flex items-center gap-2'>
									<span class='text-muted-foreground'>Points</span>
									<span class='rounded-md bg-muted px-2 py-1 font-semibold text-foreground'>
										{task.points ?? 0}
									</span>
								</div>
								{task.assignees?.length ? (
									<div class='flex items-center gap-2'>
										<span class='text-muted-foreground'>Assignees:</span>
										<div class='flex gap-1'>
											{task.assignees.map((a) => (
												<span class='rounded bg-muted px-2 py-1 text-[11px] text-foreground'>
													{a.name}
												</span>
											))}
										</div>
									</div>
								) : (
									<span class='text-emerald-700'>Unclaimed</span>
								)}
							</div>
							<div class='flex items-center justify-between text-sm'>
								<a
									href={task.githubUrl}
									class='text-orange-600 hover:text-orange-700'
									target='_blank'
									rel='noreferrer'
								>
									View on GitHub →
								</a>
								<span class='text-xs text-muted-foreground'>Updated recently</span>
							</div>
						</article>
					))
				}
			</div>
		</section>

		<section
			class='relative space-y-3 rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/5'
		>
			<div class='flex items-center justify-between'>
				<div>
					<h2 class='text-xl font-semibold text-foreground'>Hats & PRs</h2>
					<p class='text-sm text-muted-foreground'>
						Who’s wearing which hat, and where their PR stands.
					</p>
				</div>
			</div>
			<div class='flex flex-wrap gap-3'>
				{
					hats.map((h) => (
						<div class='flex flex-col gap-2 rounded-xl border border-border bg-muted/60 px-4 py-3 shadow-inner shadow-black/5 transition hover:-translate-y-0.5 hover:border-foreground/30'>
							<div class='flex items-center justify-between gap-2'>
								<span class='text-sm font-semibold text-foreground'>{h.name}</span>
								<span
									class={`rounded-md px-2 py-1 text-[11px] font-semibold ${STATUS_STYLES[h.status]}`}
								>
									{h.status}
								</span>
							</div>
							<div class='flex flex-wrap gap-1.5'>
								{h.hats.map((cat) => (
									<span
										class={`rounded-full px-2 py-1 text-[11px] font-semibold ${CATEGORY_STYLES[cat]}`}
									>
										{cat}
									</span>
								))}
							</div>
							{h.prNumber && <span class='text-xs text-muted-foreground'>PR #{h.prNumber}</span>}
						</div>
					))
				}
			</div>
		</section>

		<section
			class='relative rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/5 transition hover:-translate-y-0.5'
		>
			<h2 class='text-xl font-semibold text-foreground'>Leaderboard</h2>
			<p class='text-sm text-muted-foreground'>Points weighted by merged PRs, reviews, docs.</p>
			<div class='mt-3 space-y-2'>
				{
					leaderboard.map((entry, idx) => (
						<div class='flex items-center justify-between rounded-xl border border-border bg-muted/50 px-4 py-3'>
							<div class='flex items-center gap-3'>
								<span class='text-lg font-bold text-orange-600'>#{idx + 1}</span>
								<div>
									<div class='text-sm font-semibold text-foreground'>{entry.name}</div>
									<div class='text-xs text-muted-foreground'>
										PRs {entry.mergedPRs} · Reviews {entry.reviews} · Docs {entry.docs}
									</div>
								</div>
							</div>
							<span
								class='text-xl font-bold text-emerald-700'
								data-leaderboard-points
								data-value={entry.points}
							>
								{entry.points} pts
							</span>
						</div>
					))
				}
			</div>
		</section>

		<section id='how-to' class='relative grid gap-4 lg:grid-cols-[2fr_1fr]'>
			<div
				class='rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/5'
			>
				<h2 class='text-xl font-semibold text-foreground'>How to Ship</h2>
				<ol class='mt-3 list-decimal space-y-3 pl-5 text-sm text-muted-foreground'>
					<li>
						<span class='font-semibold text-foreground'>Claim the issue:</span> comment on GitHub to
						reserve your slot; unclaimed issues are fair game.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Branch naming:</span>
						<code class='rounded bg-slate-900 px-2 py-1 text-[11px]'>feature/your-handle-topic</code
						>.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Setup env:</span> add PostHog + Supabase keys;
						run
						<code class='rounded bg-slate-900 px-2 py-1 text-[11px]'>npm run dev</code>.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Validate:</span> play the flow, keep console
						clean, lint if you touch TS/JS.
					</li>
					<li>
						<span class='font-semibold text-foreground'>PR template:</span> include summary, screenshots/gifs
						for UI, checklist for tracking changes.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Optional:</span> add a 30–60s Loom demo for reviewers.
					</li>
				</ol>
			</div>
			<div
				class='rounded-2xl border border-border bg-primary-foreground p-4 shadow-lg shadow-black/5'
			>
				<h2 class='text-xl font-semibold text-foreground'>FAQ & Compliance</h2>
				<ul class='mt-3 space-y-2 text-sm text-muted-foreground'>
					<li>
						<span class='font-semibold text-foreground'>Non-commercial:</span> personal educational project.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Time:</span> issues marked for scope; async friendly.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Stack:</span> Astro, Tailwind, PostHog, Supabase/PostgREST,
						Plotly.
					</li>
					<li>
						<span class='font-semibold text-foreground'>Taken issue?</span> pick another or waitlist
						in comments.
					</li>
				</ul>
			</div>
		</section>
	</div>
</PageLayout>

<script>
	function addCountUp(el: HTMLElement, target: number) {
		let current = 0
		const duration = 700
		const stepTime = 16
		const steps = duration / stepTime
		const increment = target / steps
		const timer = setInterval(() => {
			current += increment
			if (current >= target) {
				current = target
				clearInterval(timer)
			}
			el.textContent = `${Math.round(current)} pts`
		}, stepTime)
	}

	const categoryButtons = Array.from(document.querySelectorAll('[data-category-btn]'))
	const statusButtons = Array.from(document.querySelectorAll('[data-status-btn]'))
	const taskCards = Array.from(document.querySelectorAll<HTMLElement>('.task-card'))

	const activeFilters: FilterState = {
		category: null,
		status: 'all'
	}

	function updateButtons() {
		categoryButtons.forEach((btn) => {
			const cat = btn.getAttribute('data-category')
			const isActive = activeFilters.category?.has(cat as Category)
			btn.classList.toggle('border-slate-400/80', !!isActive)
			btn.classList.toggle('bg-white/10', !!isActive)
			btn.setAttribute('aria-pressed', isActive ? 'true' : 'false')
		})
		statusButtons.forEach((btn) => {
			const status = btn.getAttribute('data-status')
			const isActive = status === activeFilters.status
			btn.classList.toggle('border-slate-400/80', !!isActive)
			btn.classList.toggle('bg-white/10', !!isActive)
			btn.setAttribute('aria-pressed', isActive ? 'true' : 'false')
		})
	}

	function applyFilters() {
		taskCards.forEach((card) => {
			const cardStatus = card.getAttribute('data-status') as Status
			const cardCats = (card.getAttribute('data-categories') || '')
				.split(',')
				.filter(Boolean) as Category[]

			const statusMatch = activeFilters.status === 'all' || activeFilters.status === cardStatus
			const categoryMatch =
				!activeFilters.category || cardCats.some((c) => activeFilters.category?.has(c))

			if (statusMatch && categoryMatch) {
				card.classList.remove('hidden')
			} else {
				card.classList.add('hidden')
			}
		})
	}

	function toggleCategory(cat: Category) {
		if (!activeFilters.category) {
			activeFilters.category = new Set([cat])
		} else if (activeFilters.category.has(cat)) {
			activeFilters.category.delete(cat)
			if (activeFilters.category.size === 0) {
				activeFilters.category = null
			}
		} else {
			activeFilters.category.add(cat)
		}
	}

	categoryButtons.forEach((btn) => {
		btn.addEventListener('click', () => {
			const cat = btn.getAttribute('data-category') as Category
			toggleCategory(cat)
			updateButtons()
			applyFilters()
		})
	})

	statusButtons.forEach((btn) => {
		btn.addEventListener('click', () => {
			const status = btn.getAttribute('data-status') as Status | 'all'
			activeFilters.status = status
			updateButtons()
			applyFilters()
		})
	})

	updateButtons()
	applyFilters()

	// Count up leaderboard points on load
	const leaderboardPoints = Array.from(
		document.querySelectorAll<HTMLElement>('[data-leaderboard-points]')
	)
	leaderboardPoints.forEach((el) => {
		const val = el.dataset.value
		const num = val ? parseInt(val, 10) : 0
		addCountUp(el, num)
	})
</script>
