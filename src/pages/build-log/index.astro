---
import BaseLayout from '@/layouts/BaseLayout.astro'
import PostList from '@/components/build-log/PostList.astro'
import ProjectCard from '../../../packages/shared/src/components/ProjectCard.astro'
import { parseProjectsYaml } from '../../../packages/shared/src/lib/projects'
import { getCollection } from 'astro:content'
import { validateBuildLogData } from '@/lib/build-log-types'

// Import YAML
import projectsYaml from '../../../packages/shared/src/data/projects.yaml?raw'

// Local precomputed data
import buildLogDataRaw from '@/data/build-log-data.json'

const buildLogData = validateBuildLogData(buildLogDataRaw)
if (!buildLogData) throw new Error('Invalid build-log-data.json')

const { tasks, contributors } = buildLogData

// Load projects from YAML
const projects = parseProjectsYaml(projectsYaml)

// Get posts with project:* tags
const postsAll = await getCollection('post')
const posts = postsAll
  .filter(p => !p.data.draft && (p.data.tags || []).some(t => t.startsWith('project:')))
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())

// Stats for contribute CTA
const totalContributors = contributors.length
const openCount = tasks.filter(t => t.status === 'open').length
---

<BaseLayout meta={{ title: 'The Build Log' }}>
  <div class="w-full space-y-12">
    <!-- HERO -->
    <section class="space-y-4">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-primary">The Build Log</p>
      <div class="space-y-4">
        <h1 class="text-2xl font-bold text-foreground sm:text-4xl">Learning AI-native data science by building products</h1>
        <p class="max-w-2xl text-base text-muted-foreground">
          I'm building full-stack products with AI tools, then doing data science on real user data. Everything is open: the code, the decisions, the mistakes.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="#projects" class="inline-flex items-center gap-2 bg-foreground px-5 py-2.5 text-sm font-semibold text-background shadow-sm transition hover:-translate-y-0.5 hover:bg-foreground/90">See Current Project</a>
          <a href="/build-log/contribute/" class="inline-flex items-center gap-2 border border-border bg-primary-foreground px-5 py-2.5 text-sm font-medium text-foreground transition hover:-translate-y-0.5 hover:border-foreground/30">Want to Contribute?</a>
        </div>
      </div>
    </section>

    <!-- What I'm Building -->
    <section id="projects" class="space-y-6">
      <div>
        <h2 class="text-2xl font-bold text-foreground">What I'm Building</h2>
        <p class="mt-1 text-sm text-muted-foreground">Live projects with real users and real data.</p>
      </div>
      <div class="space-y-4">
        {projects.map((project) => (
          <ProjectCard project={project} variant="full" />
        ))}
      </div>
    </section>

    <!-- What I've Learned -->
    <section id="learnings" class="space-y-6">
      <div>
        <h2 class="text-2xl font-bold text-foreground">What I've Learned</h2>
        <p class="mt-1 text-sm text-muted-foreground">Build logs, technical deep-dives, and lessons from shipping.</p>
      </div>
      <PostList posts={posts} showProjectFilter={true} />
    </section>

    <!-- Want to Contribute? -->
    <section id="contribute" class="border-t border-border pt-12">
      <a href="/build-log/contribute/" class="group block">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="space-y-2">
            <h2 class="text-2xl font-bold text-foreground">Want to Contribute?</h2>
            <p class="text-sm text-muted-foreground">Claim a task, open a PR, get code review, and ship. Real projects, real GitHub history.</p>
            <div class="flex items-center gap-4 text-sm">
              <span><span class="font-bold text-foreground">{totalContributors}</span> <span class="text-muted-foreground">contributors</span></span>
              <span><span class="font-bold text-foreground">{openCount}</span> <span class="text-muted-foreground">open tasks</span></span>
            </div>
          </div>
          <span class="inline-flex items-center gap-2 bg-foreground px-5 py-2.5 text-sm font-semibold text-background shadow-sm transition group-hover:bg-foreground/90">See Open Tasks â†’</span>
        </div>
      </a>
    </section>
  </div>
</BaseLayout>
